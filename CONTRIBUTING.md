## Contributing

[fork]: /fork
[pr]: /compare
[code-of-conduct]: CODE_OF_CONDUCT.md

Hello, Welcome! We're glad you're interested in this project, and we're trying to make contributions to it as smooth as possible! 

## Issues and PRs

If you have suggestions for how this project could be improved, or want to report a bug, open an issue! We'd love all and any contributions. If you have questions, too, we'd love to hear them.

We'd also love PRs. If you're thinking of a large PR, we advise opening up an issue first to talk about it, though! Look at the links below if you're not sure how to open a PR.

## Submitting a pull request

1. [Fork][fork] and clone the repository.
2. Configure and install the dependencies: `npm install`.
3. Create a Local Development Setup for testing
4. Make sure the tests pass on your machine: `npm test`, `npm run lint`, and `npm run e2e`, 


## Local Development Setup

To test the GitHub App locally, you need your own dev GitHub App. This involves:
- Creating a Github App
- Setting up the github app webhook events to go to your localhost, via SMEE
- Running the app
- Installing your Github App on a test repository.

It's just a few steps, you've got this!

### 1. Create GitHub App
Go to <a href="https://github.com/settings/apps/new" target="_blank">https://github.com/settings/apps/new</a> and enter:

- **App name**: `cogni-git-review-dev-<yourname>`
- **Homepage URL**: `https://github.com/Cogni-DAO/cogni-git-review`
- **Webhook URL**:  Go to <a href="https://smee.io/new" target="_blank">https://smee.io/new</a> → copy the URL
- **Webhook secret**: Generate a password: `openssl rand -hex 20` (or use `development` for testing)
- **Repository permissions**:
  - Checks: Read & write
  - Contents: Read & write
  - Metadata: Read
  - Pull requests: Read & write
  - Workflows: Read & write
- **Subscribe to events**: `Pull request`, `Check suite`, `Check run`, `Workflow run`
- **Where can this GitHub App be installed?**: Only this account

Click "Create GitHub App"

### 2. Generate Private Key & Configure Environment
Scroll down on your apps settings page to → "Generate a private key" (downloads .pem file)

Now, in your repo, fill out your .env file

Your fork of `cogni-git-review` should have a `.env.example` file in it. In your IDE:
```bash
cp .env.example .env
```

Then edit `.env`:
```bash
APP_ID=123456  # from your app page
WEBHOOK_SECRET=your-password-from-step-1
WEBHOOK_PROXY_URL=https://smee.io/your-channel
LOG_LEVEL=debug
PRIVATE_KEY=""
```

Use this command to populate the private key in your .env:
```bash
# Convert to base64, add quotes, add to .env var PRIVATE_KEY
sh -lc 'printf "PRIVATE_KEY=%s\n" "$(base64 < </path/to/key.pem> | tr -d "\n")"' >> .env
```

Using a github preview deployment? do this:
```bash
# Note: the quotes are essential for .do appspec parsing via github actions
echo "\"$(base64 -i /path/to/key.pem)\"" | gh secret set PRIVATE_KEY --env Preview
```

### 3. Run with Smee
Install smee client and start the forwarder (replace with your smee URL):
```bash
npm install -g smee-client
smee --url https://smee.io/your-channel --target http://localhost:3000/api/github/webhooks
```

It might not seem like it, but you can close this terminal window now. SMEE is set up (`npm start` will run it under the hood).

**Note**: You should open the URL `https://smee.io/your-channel` in your browser. You can see the webhook events being triggered by Github, and `Re-Deliver` any of the payloads to your localhost app!

### 4. Run the app
In another terminal, start the app:
```bash
npm start
```

**Tip**: Every time you make code changes, stop + restart the app. Changes are not auto-updated to the running app.


### 5. Install App on your Test Repo
Find your apps at <a href="https://github.com/settings/apps" target="_blank">https://github.com/settings/apps</a>

Click your app's Name → "Install App" → select your test repository (maybe forked from <a href="https://github.com/Cogni-DAO/test-repo" target="_blank">https://github.com/Cogni-DAO/test-repo</a> )


If you've done this all correctly, your test repo should have received a `Welcome PR`, generated by your local app!

### Success? 
Nice! You now have a working local development environment with your own GitHub App!

**Note**: Go delete that `app.private_key.pem` in your downloads. 

### 5. E2E Testing

Now, a final step to make your end-to-end testing easy! Generate a Personal Access Token so `npm run e2e` can modify your `test-repo`

** Note:** this assumes you've already created a `test-repo` and installed your dev app onto it.

### 1. Create Personal Access Token (PAT)
Go to [GitHub Settings > Developer Settings > Personal Access Tokens](https://github.com/settings/personal-access-tokens) and create a token with:
- **Token Name**: My Cogni Test-Repo PAT
- **Repository Access**: `Only Select Repos` -> `<username>/test-repo`
- **Permissions**: Read and Write access for `Contents`, `Actions`, `Pull Requests`, `Webhooks`, `Workflows`

Generate token, and use in the next step

### 2. Add E2E Environment Variables  
Add these to your `.env` file:
```bash
TEST_REPO=<your-username>/<your-test-repo>
TEST_REPO_GITHUB_PAT=<your-personal-access-token>
```

### 3. Run E2E Test
In one terminal:
```bash
npm start
```

Then in another terminal:

```bash
npm run e2e
```

This will:
- Clone your test repo to a temp directory
- Create a test branch with a small change
- Open a PR to trigger your dev Cogni app
- Wait for the Cogni check to complete
- Report success/failure and clean up

**Expected output**: `✅ E2E test passed!` with a JSON summary showing the test results.

---

## Development Workflow

Once your local GitHub App is set up (one-time setup above), follow this process for ongoing development:

1. Create a new branch: `git checkout -b my-branch-name`.
1. Make your change, add tests, and make sure the tests still pass.
1. Push to your fork and [submit a pull request][pr].
1. Pat your self on the back and look for Cogni's response to evaluating your PR.

Here are a few things you can do that will increase the likelihood of your pull request being accepted:

- Write and update tests.
- Keep your changes as focused as possible. If there are multiple changes you would like to make that are not dependent upon each other, consider submitting them as separate pull requests.
- Write a [good commit message](http://tbaggery.com/2008/04/19/a-note-about-git-commit-messages.html).

Work in Progress pull requests are also welcome to get feedback early on, or if there is something blocked you.

## Resources

- [How to Contribute to Open Source](https://opensource.guide/how-to-contribute/)
- [Using Pull Requests](https://help.github.com/articles/about-pull-requests/)
- [GitHub Help](https://help.github.com)

Please note that this project is released with a [Contributor Code of Conduct][code-of-conduct]. By participating in this project you agree to abide by its terms.